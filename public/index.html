<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="A song recommendation app" />

    <title>sangeet.com - Get Song Recommendations</title>
    <link
      id="favicon"
      rel="icon"
      href="https://cdn.glitch.global/885771ac-3cfa-4c5a-bde7-235096795ebd/pixlr-bg-result.png?v=1650800025230"
      type="image/x-icon"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body bgcolor="#121213">  <!-- 050A44 141619 -->
    <main id="main-content">
        <br />
        <h1 align="center">Sangeet.com</h1>
        <h4 align="center">ùÑû Discover new tracks ‚ô™</h4>
        <br />
        <div class="form-group">
            <form id="search-form" onsubmit="submitForm(event)">
                <input
                    class="form-style"
                    type="text"
                    name="track"
                    id="track"
                    placeholder="Enter your favorite song"
                />
                <input
                    class="form-style"
                    type="text"
                    name="artist"
                    id="artist"
                    placeholder="Enter artist of above track"
                />
                <input
                    class="btn mt-4"
                    type="submit"
                    id="submitButton"
                    value="Get Random Recommendation"
                />
            </form>
        </div>
      
        <div id="recommendation-output"></div>
    </main>
    <button
        id="more-recommendations"
        class="btn"
        style="display: none; margin: 20px auto"
    >
        More Recommendations
    </button>

    <br /><br /><br />
    <footer style="color: white">
        Developed by <a href="https://github.com/Stratonov16">Nikhil</a> with ‚ù§Ô∏è
    </footer>
    <div
        class="glitchButton"
        style="position: fixed; top: 2em; right: 20px"
    ></div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        const axios = window.axios;
        const handlebars = window.Handlebars;
        const output = document.getElementById("recommendation-output");
        const moreButton = document.getElementById("more-recommendations");

        let currentPage = 0;
        let track = "";
        let artist = "";

        const showToast = (message, type) => {
            if (document.querySelectorAll(".toastify-error").length > 0) {
                return;
            }

            // Show the toast with custom color and shape
            Toastify({
                text: message,
                duration: 3000,
                backgroundColor: type === "error" ? "red" : "blue",
                close: true,
                gravity: "top",
                position: "right",
                className: `toastify toastify-${type}`,
                style: {
                    border: type === "error" ? "2px solid darkred" : "2px solid darkblue",
                    borderRadius: "10px",
                    padding: "10px",
                    boxShadow: "0px 4px 6px rgba(0, 0, 0, 0.1)",
                },
            }).showToast();
        };

        const submitForm = async (event) => {
            event.preventDefault();
            const { elements } = event.target;
            track = elements.track.value.trim();
            artist = elements.artist.value.trim();

            // Check if one of the fields is filled but not the other
            if ((track && !artist) || (!track && artist)) {
                showToast("Please fill in both the track and artist fields or leave both empty for a random recommendation.", "error");
                return;
            }

            currentPage = 0;
            output.innerHTML = ""; // Clear previous recommendations
            moreButton.style.display = "none"; // Hide the button before fetching new recommendations

            await fetchRecommendations();
        };

        const fetchRecommendations = async () => {
            let result;
            try {
                result = await axios.post("/recommendations", {
                    track,
                    artist,
                    page: currentPage,
                });
            } catch (err) {
                let errMsg = "Something went wrong";
                if (err.response && err.response.data && err.response.data.message) {
                    errMsg = err.response.data.message;
                }
                showToast(errMsg, "error");
                return;
            }

            const recommendations = result.data.tracks;
            if (!recommendations.length) {
                showToast("No recommendations found.", "warning");
                moreButton.style.display = "none";
                return;
            }

            currentPage += 1;

            const template = handlebars.compile(templateRaw);
            const recommendationsHtml = template({ track, recommendations });
            output.innerHTML += recommendationsHtml;

            // Show the "More Recommendations"
            moreButton.style.display = "block";
        };

        const loadMoreRecommendations = async () => {
            await fetchRecommendations();
        };

        const templateRaw = `
            <h6>If you like "{{track}}", you'll love:</h6>
            <ul>
                {{#each recommendations}}
                <li>
                    <h6>
                        <a href="{{external_urls.spotify}}">
                            <img src="{{album.images.2.url}}" width="64px">
                            {{name}}
                        </a>
                        by {{#each artists}}{{name}}{{#unless @last}}, {{/unless}}{{/each}}
                        <br>
                        <audio controls>
                            <source src="{{preview_url}}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </h6>
                </li>
                {{/each}}
            </ul>
        `;

        document.getElementById("search-form").addEventListener("submit", submitForm);
        moreButton.addEventListener("click", loadMoreRecommendations);

        // Additional JavaScript for dynamic button text and validation
        document.addEventListener('DOMContentLoaded', () => {
            const trackInput = document.getElementById('track');
            const artistInput = document.getElementById('artist');
            const submitButton = document.getElementById('submitButton');

            function updateButton() {
                if (trackInput.value.trim() === '' && artistInput.value.trim() === '') {
                    submitButton.value = "Get Random Recommendation";
                } else {
                    submitButton.value = "Get recommendations";
                }
            }

            trackInput.addEventListener('input', updateButton);
            artistInput.addEventListener('input', updateButton);

            // Initial call to set button text based on default values
            updateButton();
        });
    </script>
      <script src="./script.js" defer></script>
</body>
</html>
